---
- include_tasks: debian.yml
  when: ansible_os_family == 'Debian'
- name: make port 80 available for certbot standalone to work
  block:
    - name: Stop webserver
      service:
        name: "{{ certbot_webserver_installed }}"
        state: stopped
      ignore_errors: yes

    - name: Check whether port 80 is available
      wait_for:
        port: 80
        state: stopped
        timeout: "{{ certbot_waitfor_port_seconds }}"
  when: certbot_plugin == "standalone"

- name: Create and install cert using {{ certbot_plugin }} plugin
  command: "certbot --{{ certbot_plugin }} {{ (certbot_install_cert) | ternary('','certonly') }} -d {{ certbot_site_names | join(', ') }} -m {{ certbot_mail_address }} --agree-tos --noninteractive --text --cert-name {{ certbot_cert_name | default(certbot_site_names[0]) }}"

- include_tasks: copy-files.yml

- name: Create cron job to renew certs every month
  cron:
    name: renewCertbotCerts
    minute: "{{ certbot_renew_certs_minute }}"
    hour: "{{ certbot_renew_certs_hour }}"
    month: "{{ certbot_renew_certs_month }}"
    weekday: "{{ certbot_renew_certs_weekday }}"
    job: /usr/bin/certbot renew --prehook "{{ certbot_renew_prehook }}" --post-hook "{{ certbot_renew_posthook }}"
  when:
    - certbot_create_certs
    - certbot_plugin == "standalone"

- name: Start webserver
  service:
    name: "{{ certbot_webserver_installed }}"
    state: started
  ignore_errors: yes
  when: certbot_plugin == "standalone"
